<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索结果 - {{ query }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
</head>
<body>
    <div class="container">
        <div class="search-header">
            <a href="{{ url_for('main.index') }}" class="back-link">&larr; 返回首页</a>            <h1>搜索结果: "{{ query }}"</h1>
            <form method="GET" action="{{ url_for('main.search_results') }}" class="search-bar-results">
                <div class="search-container">
                    <div class="search-type-toggle">
                        <button type="button" id="search-type-btn" class="search-type-btn" onclick="toggleSearchType()">
                            <span id="search-type-text">{{ '文档搜索' if search_type == 'document' else '网页搜索' }}</span>
                        </button>
                    </div>
                    <input type="text" id="search-input" name="query" value="{{ query }}" placeholder="输入搜索关键词..." required autocomplete="off">
                    <input type="hidden" id="search-type" name="search_type" value="{{ search_type }}">
                    <div id="search-suggestions" class="suggestions-box"></div>
                    <button type="submit">搜索</button>
                </div>
            </form>
        </div>          {% if results %}
            <p class="results-count">
                找到约 {{ total_hits }} 条结果
                {% if search_time %}
                    <span class="search-time">({{ search_time|round(3) }} 秒)</span>
                {% endif %}
                {% if search_stats and search_stats.max_score > 0 %}
                    <span class="search-relevance">, 最高相关度: {{ search_stats.max_score|round(2) }}</span>
                {% endif %}
                {% if user_college and user_role %}
                    <span class="personalization-info">
                        | 已为 {{ user_college }}-{{ user_role }} 个性化排序
                        {% if personalization_stats and personalization_stats.avg_personalized_score > 0 %}
                            (匹配度: {{ (personalization_stats.avg_personalized_score * 100)|round(1) }}%)
                        {% endif %}
                    </span>
                {% endif %}
            </p>
              {% if query_suggestion %}
                <div class="query-suggestion">
                    您是否要搜索: <a href="{{ url_for('main.search_results', query=query_suggestion, search_type=search_type) }}">{{ query_suggestion }}</a>
                </div>
            {% endif %}
            
            {% if clusters and clusters|length > 1 %}
                <div class="cluster-container">
                    <div class="cluster-header">相关主题：</div>
                    <div class="cluster-items">
                        {% for cluster in clusters %}
                            <div class="cluster-item">
                                <span class="cluster-name">{{ cluster.name }}</span>
                                <span class="cluster-count">({{ cluster.count }})</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            <!-- 个性化统计信息显示 -->
            {% if personalization_stats and personalization_stats.total_results > 0 %}
                <div class="personalization-stats">
                    <h4>个性化排序统计信息</h4>
                    <div class="stat-item">
                        学院匹配: <span class="stat-value">{{ personalization_stats.college_matched }}</span> 个结果
                    </div>
                    <div class="stat-item">
                        身份匹配: <span class="stat-value">{{ personalization_stats.role_matched }}</span> 个结果
                    </div>
                    <div class="stat-item">
                        域名匹配: <span class="stat-value">{{ personalization_stats.domain_matched }}</span> 个结果
                    </div>
                    <div class="stat-item">
                        平均个性化分数: <span class="stat-value">{{ (personalization_stats.avg_personalized_score * 100)|round(1) }}%</span>
                    </div>
                </div>
            {% endif %}
              {% if total_hits > 0 %}
            {% endif %}
            
            <ul class="results-list">
                {% for result in results %}
                <li class="result-item">
                    <h2>
                        <a href="{{ result.url }}" target="_blank">
                            {% if "[" in result.title and "]" in result.title %}
                                {{ result.title | safe }}
                            {% else %}
                                {{ result.title | safe }}
                                {% if (result.is_attachment or search_type == 'document') and result.file_type and result.file_type != '未知文档' %}
                                    [{{ result.file_type }}]
                                {% endif %}
                            {% endif %}
                        </a>
                    </h2>
                    {% if result.is_attachment or search_type == 'document' %}
                        <p class="result-info">
                            {% if result.filename %}
                                <span class="file-name">文件名: {{ result.filename }}</span>
                            {% endif %}
                            {% if result.file_type and result.file_type != '未知文档' %}
                                <span class="file-type">文件类型: {{ result.file_type }}</span>
                            {% endif %}
                        </p>                    {% endif %}
                    <p class="result-url">{{ result.url }}</p>
                    <p class="result-snippet">{{ result.snippet | safe }}</p>
                    
                    <!-- 个性化分数显示（调试信息） -->
                    {% if result.personalized_score is defined and result.personalized_score > 0 %}
                        <p class="personalization-debug" style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            个性化分数: {{ (result.personalized_score * 100)|round(1) }}% 
                            | 原始分数: {{ result.score|round(2) }}
                            {% if result.final_score is defined %}
                                | 综合分数: {{ result.final_score|round(3) }}
                            {% endif %}
                        </p>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            
            <!-- 添加分页功能 -->
            {% if total_hits > 10 %}
            <div class="pagination">                {% set total_pages = (total_hits / 10) | round(0, 'ceil') | int %}
                {% if page > 1 %}
                    <a href="{{ url_for('main.search_results', query=query, page=page-1, search_type=search_type) }}">&laquo; 上一页</a>
                {% endif %}
                
                {% for p in range(max(1, page-2), min(page+3, total_pages+1)) %}
                    {% if p == page %}
                        <span class="current-page">{{ p }}</span>
                    {% else %}
                        <a href="{{ url_for('main.search_results', query=query, page=p, search_type=search_type) }}">{{ p }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if page < total_pages %}
                    <a href="{{ url_for('main.search_results', query=query, page=page+1, search_type=search_type) }}">下一页 &raquo;</a>
                {% endif %}
            </div>
            {% endif %}
        {% elif query %}
            <p>没有找到与 "{{ query }}" 相关的结果。</p>
        {% else %}
             <p>请输入关键词进行搜索。</p>
        {% endif %}
    </div>
</body>
</html>
